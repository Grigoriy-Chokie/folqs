{{- 'cta-banner-with-media.css' | asset_url | stylesheet_tag -}}

{%- style -%}
  #shopify-section-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
  }
  #shopify-section-{{ section.id }} .cta-banner__title{
      font-size: {{section.settings.title_size}}px;
      line-height: 125%;
      font-weight: {{ section.settings.title_weight }};
  }
  @media screen and (max-width: 900px) {
      #shopify-section-{{ section.id }} .cta-banner__title{
        font-size: {{section.settings.title_size_mobile}}px;
      }
  }
  
  {% unless section.settings.button_background == blank %}
    #shopify-section-{{ section.id }} .cta-banner__button {
      background: {{section.settings.button_background}};
      border: 1px solid {{section.settings.button_background}};
    }

    #shopify-section-{{ section.id }} .cta-banner__button:hover {
      background: transparent;
      color: {{section.settings.button_background}};
    }
  {% endunless %}

  @media screen and (max-width: 768px) {
      #shopify-section-{{ section.id }} {
          padding-top: {{ section.settings.padding_top_mobile }}px;
          padding-bottom: {{ section.settings.padding_bottom_mobile }}px;
      }
  }
{%- endstyle -%}
{% liquid 
  assign uspBlocksCount = 0
  assign islandsBlocksCount = 0
  if section.blocks.size > 0 
    for block in section.blocks
      case block.type
        when 'usp'
          assign uspBlocksCount = uspBlocksCount | plus: 1
        when 'floating_island'
          assign islandsBlocksCount  = islandsBlocksCount  | plus: 1
      endcase
    endfor
  endif
%}
<div class="cta-banner__section {% if islandsBlocksCount > 0 %} cta-banner__section--with-islands{% endif %} {% if section.settings.restrict_section_width %}page-width{% else %}page-width--left-only{% endif %} {% if section.settings.is_flipped %} cta-banner__section--flipped {% endif %} {% if section.settings.is_full_width %} cta-banner--full-width {% endif %}">
  {% liquid 
      assign popup_heading = section.settings.popup_heading
      assign popup_metaobject_handle = section.settings.popup_metaobject_handle
      assign popup_metaobject = shop.metaobjects.supplement_facts[popup_metaobject_handle]
      assign image_popup = section.settings.image_popup
      assign image_popup_mobile = section.settings.image_popup_mobile
  %}

  {% unless popup_metaobject_handle == blank and image_popup == blank %}
    <div class="cta-banner__popup-overlay" onclick="deactivatePopup(event)">
      <div class="cta-banner__popup">
        {% unless popup_heading == blank %}
          <div class = "popup__heading-wrapper">
            <h5 class = "popup__title">
              {{ popup_heading }}
            </h5>
            <div class="popup__close-button" onclick="deactivatePopup(event)">
              {% render 'popup-close-icon' %}
            </div>
          </div>
        {% endunless %}

        {% if popup_metaobject %}
          <div class="popup__content-wrapper">
            {% render 'supplement-facts-popup' | metaobject: popup_metaobject %}
          </div>
        {% else %}
          <div class="popup__image-wrapper">
            <picture>
              {% if image_popup_mobile != blank %}
                <source srcset="{{ image_popup_mobile | img_url: "master" }}" media="(max-width: 750px)">
              {% endif %}
              {{ image_popup | image_url: width: 700 | image_tag: loading: 'lazy', class: 'popup__image', alt: image_popup.alt }}
            </picture>
          </div>
        {% endif %}
      </div>
    </div>
  {% endunless %}
  <div class="cta-banner__content {% if section.settings.image == blank %} cta-banner__content--full-width {% endif %} {% if section.settings.is_cta_button_centered %}cta-banner__content--without-button {% endif %}">
    {% if section.settings.title != blank %}
      <h2 class="cta-banner__title {% if section.settings.title_mobile != blank %}cta-banner__title--desktop {% endif %}">
        {{ section.settings.title }}
      </h2>
      {% if section.settings.title_mobile != blank %}
        <h2 class="cta-banner__title cta-banner__title--mobile ">{{ section.settings.title_mobile }}</h2>
      {% endif %}
    {% endif %}
    {% if uspBlocksCount > 0 %}
      <ul class="cta-banner__usp-items">
        {% for block in section.blocks %}
          {% if block.type == 'usp' %}
            <li class="usp-item">
              {% if block.settings.icon != blank %}
                <div class="usp-item__icon">
                  {{ block.settings.icon | image_url: width: 100 | image_tag: loading: 'lazy', alt: block.settings.icon.alt }}
                </div>
              {% endif %}
              {% if block.settings.title != blank or block.settings.text != blank %}
                <div class="usp-item__content">
                  {% if block.settings.title != blank %}
                    <h4 class="usp-item__title">{{ block.settings.title }}</h4>
                  {% endif %}
                  {% if block.settings.text != blank %}
                    <div class="usp-item__text">{{ block.settings.text }}</div>
                  {% endif %}
                </div>
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    {% endif %}
    {% unless section.settings.is_cta_button_centered %}
      {% if section.settings.button_text != blank %}
        <{% unless section.settings.image_popup == blank %}div onclick="activatePopup(this.closest('.cta-banner'))"{% elsif section.settings.button_link != blank  %}a href="{{ section.settings.button_link }}"{% endunless %}
          class="cta-banner__button {% if section.settings.is_button_hidden %} cta-banner__button--no-mobile {% endif %}"
        >
          {{ section.settings.button_text }}
          {% render 'icon-arrow-right' %}
        </{% unless section.settings.image_popup == blank %}div{% else %}a{% endunless %}>
      {% endif %}
    {% endunless %}
  </div>
  {% if section.settings.image != blank %}
    <div class="cta-banner__media {% if islandsBlocksCount > 0 %} cta-banner__media--restricted {% endif %}">
    {% if islandsBlocksCount > 0 %} 

        {% liquid 
          assign islandsBlocksCountHalf = islandsBlocksCount | divided_by: 2 | round | plus: 1 
          assign currentIndexX = 0 
          assign currentIndexY = 0 
          assign islandsBlocksCountHalfForIndexY = islandsBlocksCountHalf | minus: 1 
        %}
        {% for block in section.blocks %}
          {% if block.type == 'floating_island' and block.settings.title != blank %}
            {% if currentIndexX == islandsBlocksCountHalf %}
              {% assign currentIndexX = 0 %}
            {% endif %}
            {% style %}
              #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                top: calc(10% + 46px * {{ currentIndexY }});
                {% if currentIndexY < islandsBlocksCountHalfForIndexY %}
                  right: calc(29% + 23% * {{ currentIndexX }});
                {% elsif currentIndexY ==  islandsBlocksCountHalfForIndexY %}
                  right: calc(29% + 15% * {{ currentIndexX }});
                {% else %}
                  right: calc(29% + 23% * {{ islandsBlocksCountHalf | minus: currentIndexX | minus: 2}} );
                {% endif %}
              }
              @media screen and (min-width: 1800px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(60px * {{ currentIndexY | plus: 1 }});
                  {% if currentIndexY < islandsBlocksCountHalfForIndexY %}
                    right: calc(20% + 23% * {{ currentIndexX }});
                  {% elsif currentIndexY ==  islandsBlocksCountHalfForIndexY %}
                    right: calc(20% + 15% * {{ currentIndexX }});
                  {% else %}
                    right: calc(20% + 23% * {{ islandsBlocksCountHalf | minus: currentIndexX | minus: 2}} );
                  {% endif %}
                }
              }
              @media screen and (min-width: 2300px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: -60px;
                }
              }
              @media screen and (max-width: 1300px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(15% + 46px * {{ currentIndexY }});
                }
              }
              @media screen and (max-width: 1175px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(20% + 46px * {{ currentIndexY }});
                }
              }
              @media screen and (max-width: 1000px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(25% + 46px * {{ currentIndexY }});
                }
              }
              @media screen and (max-width: 900px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(19% + 46px * {{ currentIndexY }});
                  {% if currentIndexY < islandsBlocksCountHalfForIndexY %}
                    right: calc(19% + 15% * {{ currentIndexX }});
                  {% elsif currentIndexY ==  islandsBlocksCountHalfForIndexY %}
                    right: calc(19% + 10% * {{ currentIndexX }});
                  {% else %}
                    right: calc(19% + 15% * {{ islandsBlocksCountHalf | minus: currentIndexX | minus: 2}} );
                  {% endif %}
                }
              }
              @media screen and (max-width: 600px) {
                #shopify-section-{{ section.id }} .floating-islands__island-item-{{ forloop.index }}{
                  top: calc(15% + 46px * {{ currentIndexY }});
                  {% if currentIndexY < islandsBlocksCountHalfForIndexY %}
                    right: calc(19% + 26% * {{ currentIndexX }});
                  {% elsif currentIndexY ==  islandsBlocksCountHalfForIndexY %}
                    right: calc(19% + 17% * {{ currentIndexX }});
                  {% else %}
                    right: calc(19% + 26% * {{ islandsBlocksCountHalf | minus: currentIndexX | minus: 2}} );
                  {% endif %}
                }
              }
            {% endstyle %}
            <div class="floating-islands__island-item floating-islands__island-item-{{ forloop.index }} scroll-trigger animate--slide-in"  style="--animation-order: {{ forloop.index }};">
                <span class="floating-islands__island-text">{{ block.settings.title }}</span>
                {% render 'blue-circle' %}
            </div>
            {% assign currentIndexX = currentIndexX | plus: 1 %}
            {% assign currentIndexY = currentIndexY | plus: 1 %}
          {% endif %}
        {% endfor %}
    {% endif %}
      {{ section.settings.image | image_url: width: 2000 | image_tag: loading: 'lazy', class: 'image--desktop', alt: section.settings.image.alt }}
      {% if section.settings.image_mobile != blank %}
        {{ section.settings.image_mobile | image_url: width: 2000 | image_tag: loading:  'lazy', class: 'image--mobile', alt: section.settings.image_mobile.alt }}
      {% endif %}
      {% if islandsBlocksCount > 0 %} 
        {% render 'cta-banner-blue-circle' %}
        {% render 'cta-banner-grey-circle' %}
      {% endif %}
    </div>
  {% endif %}
</div>
{% if section.settings.is_cta_button_centered %}
  {% if section.settings.button_text != blank %}
    <{% unless section.settings.image_popup == blank %}div onclick="activatePopup(this.closest('.cta-banner'))"{% elsif section.settings.button_link != blank  %}a href="{{ section.settings.button_link }}"{% endunless %}
      class="cta-banner__button {% if section.settings.is_button_hidden %} cta-banner__button--no-mobile {% endif %} cta-banner__button--separated"
    >
      {{ section.settings.button_text }}
      {% render 'icon-arrow-right' %}
    </{% unless section.settings.image_popup == blank %}div{% else %}a{% endunless %}>
  {% endif %}
{% endif %}
{{- 'cta-banner-with-media-content-locator.js' | asset_url | script_tag -}}
{{- 'cta-banner-popup.js' | asset_url | script_tag -}}
{% schema %}
{
  "name": "CTA Banner with media",
  "tag": "section",
  "class": "cta-banner",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "paragraph",
      "content": "Desktop"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    },
    {
      "type": "paragraph",
      "content": "Mobile"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "The Only Multivitamin Youâ€™ll Ever Need"
    },
    {
      "type": "text",
      "id": "title_mobile",
      "label": "Title mobile"
    },
    {
      "type": "range",
      "id": "title_weight",
      "min": 100,
      "max": 1000,
      "step": 100,
      "unit": "px",
      "label": "Title font weight",
      "default": 500
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 5,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Title font size",
      "default": 48
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "min": 5,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Mobile title font size",
      "default": 32
    },
    {
      "type": "paragraph",
      "content": "Images"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Desktop",
      "info": "Use image in .svg or .png formats!"
    },
    {
      "type": "image_picker",
      "id": "image_mobile",
      "label": "Mobile",
      "info": "Use image in .svg or .png formats!"
    },
    {
      "type": "checkbox",
      "label": "Display image full width",
      "id": "is_full_width",
      "default": false
    },
    {
      "type": "checkbox",
      "label": "Display flipped",
      "id": "is_flipped",
      "default": false
    },
    {
      "type": "checkbox",
      "label": "Restrict section width",
      "id": "restrict_section_width",
      "default": false
    },
    {
      "type": "paragraph",
      "content": "Popup"
    },
    {
      "type": "text",
      "id": "popup_heading",
      "label": "popup heading",
      "default": "Supplement Facts"
    },
    {
      "type": "text",
      "id": "popup_metaobject_handle",
      "label": "Content Metaobject handle",
      "info": "Add handle of created metaobject."
    },
    {
      "type": "image_picker",
      "id": "image_popup",
      "label": "Popup image",
      "info": "Will be displayed as pop up image linked to button click"
    },
    {
      "type": "image_picker",
      "id": "image_popup_mobile",
      "label": "Popup image for mobile"
    },
    {
      "type": "paragraph",
      "content": "CTA Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Text",
      "default": "Try it Now"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "URL"
    },
    {
      "type": "checkbox",
      "label": "Hide button on mobile",
      "id": "is_button_hidden",
      "default": true
    },
    {
      "type": "checkbox",
      "label": "Center cta button",
      "id": "is_cta_button_centered",
      "default": false
    },
    {
      "type": "color_background",
      "label": "Button background",
      "id": "button_background",
      "default": "#005EB8"
    },
  ],
  "blocks": [
    {
      "name": "USP",
      "type": "usp",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon",
          "info": "It is recommended to use .svg or .png formats."
        },
        {
          "type": "header",
          "content": "Text"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Title"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Content",
          "default": "<p>Some text</p>"
        }
      ]
    },
    {
      "name": "Floating island ",
      "type": "floating_island",
      "settings": [
        {
          "type": "header",
          "content": "Text"
        },
        {
          "type": "richtext",
          "id": "title",
          "label": "Title"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "CTA Banner with media"
    }
  ]
}
{% endschema %}
